const nameInput=document.getElementById("displayName"),bioInput=document.getElementById("bio"),pronounceInput=document.getElementById("pronounce"),avatarInput=document.getElementById("avatar"),avatarPreview=document.getElementById("preview-avatar"),usernameInput=document.getElementById("username"),emailInput=document.getElementById("email"),locationInput=document.getElementById("location"),saveButton=document.getElementById("saveChanges");let avatarChanged=!1;function checkChanges(){return""!=nameInput.value&&(nameInput.value!=nameInput.getAttribute("data-value")||bioInput.value!=bioInput.getAttribute("data-value")||pronounceInput.value!=pronounceInput.getAttribute("data-value")||usernameInput.value!=usernameInput.getAttribute("data-value")||emailInput.value!=emailInput.getAttribute("data-value")||locationInput.value!=locationInput.getAttribute("data-value")||!!avatarChanged)}function getChanges(){const e=[];return nameInput.value!=nameInput.getAttribute("data-value")&&e.push({name:"displayname",value:nameInput.value}),bioInput.value!=bioInput.getAttribute("data-value")&&e.push({name:"bio",value:bioInput.value}),pronounceInput.value!=pronounceInput.getAttribute("data-value")&&e.push({name:"pronounce",value:pronounceInput.value}),usernameInput.value!=usernameInput.getAttribute("data-value")&&e.push({name:"username",value:usernameInput.value}),emailInput.value!=emailInput.getAttribute("data-value")&&e.push({name:"email",value:emailInput.value}),locationInput.value!=locationInput.getAttribute("data-value")&&e.push({name:"location",value:locationInput.value}),avatarChanged&&e.push({name:"avatar",value:avatarPreview.src}),e}function showUnsavedChanges(){document.getElementById("unsavedChanges").style.display="block"}function hideUnsavedChanges(){document.getElementById("unsavedChanges").style.display="none"}function onAnyInput(e){e.preventDefault(),checkChanges()?showUnsavedChanges():hideUnsavedChanges()}function saveChanges(){getChanges().forEach((async e=>{const t=await fetch(`/api/user/${e.name}`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`${document.cookie.split("token=")[1].split(";")[0]}`},body:JSON.stringify({value:e.value})}),a=await t.json();console.log(a),a.succes?"displayname"==e.name?(nameInput.setAttribute("data-value",nameInput.value),document.querySelector(".user-info .username .text").innerText=nameInput.value):"avatar"==e.name?(avatarPreview.src=e.value,avatarChanged=!1,document.querySelector(".user-info .username img").src=avatarPreview.src):"username"==e.name?(usernameInput.setAttribute("data-value",usernameInput.value),document.querySelector(".user-info .user-actions .profile-link").href=`/@${usernameInput.value}`):"email"==e.name?emailInput.setAttribute("data-value",emailInput.value):"location"==e.name?locationInput.setAttribute("data-value",locationInput.value):"bio"==e.name?bioInput.setAttribute("data-value",bioInput.value):"pronounce"==e.name&&pronounceInput.setAttribute("data-value",pronounceInput.value):(console.log("Failed to save changes of "+e.name),alert("Failed to save changes of "+e.name))})),hideUnsavedChanges()}nameInput.addEventListener("input",onAnyInput),bioInput.addEventListener("input",onAnyInput),pronounceInput.addEventListener("input",onAnyInput),usernameInput.addEventListener("input",onAnyInput),emailInput.addEventListener("input",onAnyInput),locationInput.addEventListener("input",onAnyInput),saveButton.addEventListener("click",saveChanges),avatarInput.addEventListener("change",(e=>{const t=e.target.files[0],a=new FileReader;a.readAsDataURL(t),a.onload=()=>{avatarPreview.src=a.result,avatarChanged=!0,onAnyInput(e);const t=document.createElement("canvas"),n=t.getContext("2d");avatarPreview.onload=()=>{t.width=200,t.height=200,n.drawImage(avatarPreview,0,0,200,200);const e=t.toDataURL("image/png");avatarPreview.src=e}}}));